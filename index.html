<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ERP Lucas">
    <title>ERP Lucas</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-card: #161616;
            --bg-hover: #1c1c1c;
            --bg-modal: rgba(0,0,0,0.85);
            --border: #262626;
            --border-light: #333;
            --text-primary: #fff;
            --text-secondary: #a3a3a3;
            --text-muted: #737373;
            --green: #22c55e;
            --green-dim: rgba(34,197,94,0.15);
            --green-dark: #16a34a;
            --red: #ef4444;
            --red-dim: rgba(239,68,68,0.15);
            --blue: #3b82f6;
            --blue-dim: rgba(59,130,246,0.15);
            --yellow: #eab308;
            --yellow-dim: rgba(234,179,8,0.15);
            --purple: #a855f7;
            --purple-dim: rgba(168,85,247,0.15);
            --cyan: #06b6d4;
            --cyan-dim: rgba(6,182,212,0.15);
            --orange: #f97316;
        }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { font-family:'Inter',system-ui,sans-serif; background:var(--bg-primary); color:var(--text-primary); min-height:100vh; min-height:100dvh; overflow-x:hidden; }
        
        /* ============ TICKER BAR ============ */
        .ticker-bar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            overflow: hidden;
            height: 36px;
            display: flex;
            align-items: center;
            position: relative;
        }
        .ticker-track {
            display: flex;
            width: max-content;
            animation: tickerScroll 20s linear infinite;
        }
        .ticker-track:hover { animation-play-state: paused; }
        .ticker-group {
            display: flex;
            gap: 40px;
            padding: 0 20px;
        }
        @keyframes tickerScroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .ticker-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        .ticker-label { color: var(--text-muted); }
        .ticker-value { font-family: 'Space Mono', monospace; font-weight: 500; }
        .ticker-change { font-size: 11px; }
        .ticker-change.up { color: var(--green); }
        .ticker-change.down { color: var(--red); }

        /* ============ HEADER ============ */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-inner {
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 17px;
        }
        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--green), var(--cyan));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        .sync-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-muted);
        }
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--green);
            animation: pulse 2s infinite;
        }
        .sync-dot.syncing { background: var(--yellow); animation: spin 1s linear infinite; }
        .sync-dot.error { background: var(--red); animation: none; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
        @keyframes spin { to{transform:rotate(360deg)} }

        /* ============ NAV ============ */
        .nav {
            display: flex;
            gap: 4px;
            padding: 10px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
            scrollbar-width: none;
        }
        .nav::-webkit-scrollbar { display: none; }
        .nav-btn {
            padding: 9px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .nav-btn:hover { background: var(--bg-card); color: var(--text-primary); }
        .nav-btn.active { background: var(--text-primary); color: var(--bg-primary); }

        /* ============ MAIN ============ */
        .main {
            max-width: 1000px;
            margin: 0 auto;
            padding: 16px;
            padding-bottom: 100px;
        }
        .view { display: none; animation: fadeIn 0.25s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

        /* ============ CARDS ============ */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 14px;
        }
        .card-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        /* ============ KPI GRID ============ */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }
        @media (min-width: 600px) {
            .kpi-grid { grid-template-columns: repeat(4, 1fr); }
        }
        .kpi {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .kpi:hover { border-color: var(--border-light); transform: translateY(-1px); }
        .kpi:active { transform: scale(0.98); }
        .kpi-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .kpi-value {
            font-family: 'Space Mono', monospace;
            font-size: 18px;
            font-weight: 700;
        }
        @media (min-width: 600px) {
            .kpi-value { font-size: 20px; }
        }

        /* ============ MONTH SELECTOR ============ */
        .month-sel {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }
        .month-btn {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }
        .month-btn:hover { background: var(--bg-hover); }
        .month-display {
            font-size: 16px;
            font-weight: 600;
            min-width: 130px;
            text-align: center;
        }
        .edit-income-btn {
            margin-left: auto;
            padding: 6px 12px;
            border-radius: 6px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .edit-income-btn:hover { background: var(--bg-hover); color: var(--text-primary); }

        /* ============ CHARTS ============ */
        .charts-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 14px;
        }
        @media (min-width: 600px) {
            .charts-row { grid-template-columns: 1fr 1fr; }
        }
        .chart-box { height: 220px; position: relative; }
        @media (min-width: 600px) {
            .chart-box { height: 260px; }
        }

        /* ============ TRANSACTIONS ============ */
        .tx-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .tx-title { font-size: 14px; font-weight: 600; }
        .tx-more {
            font-size: 12px;
            color: var(--green);
            background: none;
            border: none;
            cursor: pointer;
        }
        .tx-list { position: relative; }
        .tx-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            position: relative;
            transition: transform 0.2s, background 0.2s;
            cursor: pointer;
        }
        .tx-item:last-child { border: none; }
        .tx-item:hover { background: var(--bg-hover); margin: 0 -16px; padding: 12px 16px; border-radius: 8px; }
        .tx-item.swiped { transform: translateX(80px); }
        .tx-delete-bg {
            position: absolute;
            left: -80px;
            top: 0;
            bottom: 0;
            width: 80px;
            background: var(--red);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            border-radius: 8px 0 0 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .tx-item.swiped .tx-delete-bg { opacity: 1; }
        .tx-icon {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        .tx-info { flex: 1; min-width: 0; }
        .tx-desc {
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .tx-meta { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
        .tx-amount {
            font-family: 'Space Mono', monospace;
            font-size: 13px;
            font-weight: 600;
            text-align: right;
        }
        
        /* Category colors */
        .cat-comida { background: var(--red-dim); }
        .cat-servicios { background: var(--blue-dim); }
        .cat-salidas { background: var(--purple-dim); }
        .cat-deporte { background: var(--green-dim); }
        .cat-regalos { background: var(--yellow-dim); }
        .cat-educaci√≥n, .cat-educacion { background: var(--cyan-dim); }
        .cat-tarjeta { background: var(--purple-dim); }
        .cat-otros { background: rgba(115,115,115,0.15); }

        /* ============ TABS ============ */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 14px;
            background: var(--bg-card);
            padding: 4px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        .tab {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab.active {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        /* ============ FILTERS ============ */
        .filters {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            overflow-x: auto;
            padding-bottom: 4px;
            scrollbar-width: none;
        }
        .filters::-webkit-scrollbar { display: none; }
        .filter-chip {
            padding: 7px 12px;
            border-radius: 50px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .filter-chip:hover { border-color: var(--border-light); }
        .filter-chip.active {
            background: var(--text-primary);
            color: var(--bg-primary);
            border-color: var(--text-primary);
        }

        /* ============ PATRIMONIO ============ */
        .pat-total {
            background: linear-gradient(135deg, var(--bg-card), rgba(34,197,94,0.08));
            border: 1px solid var(--green);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 14px;
            text-align: center;
        }
        .pat-total-label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
        .pat-total-value {
            font-family: 'Space Mono', monospace;
            font-size: 28px;
            font-weight: 700;
            color: var(--green);
        }
        .pat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 14px;
        }
        .pat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .pat-card:hover { border-color: var(--border-light); }
        .pat-card:active { transform: scale(0.98); }
        .pat-card.expanded { grid-column: 1 / -1; }
        .pat-label { font-size: 11px; color: var(--text-muted); margin-bottom: 3px; }
        .pat-value {
            font-family: 'Space Mono', monospace;
            font-size: 16px;
            font-weight: 700;
        }
        .pat-detail {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        .pat-card.expanded .pat-detail { display: block; }

        /* ============ INVESTMENTS ============ */
        .inv-list { margin-top: 14px; }
        .inv-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .inv-item:hover { border-color: var(--border-light); }
        .inv-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .inv-name { font-size: 14px; font-weight: 500; }
        .inv-amount {
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            font-weight: 600;
            color: var(--green);
        }
        .inv-details {
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-secondary);
        }
        .inv-item.expanded .inv-details { display: block; }
        .inv-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }
        .inv-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .inv-action-btn {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .inv-action-btn.edit {
            background: var(--blue-dim);
            color: var(--blue);
        }
        .inv-action-btn.delete {
            background: var(--red-dim);
            color: var(--red);
        }

        /* ============ MOVEMENTS ============ */
        .mov-list { margin-top: 14px; }
        .mov-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }
        .mov-item:last-child { border: none; }
        .mov-date { color: var(--text-muted); width: 60px; flex-shrink: 0; }
        .mov-desc { flex: 1; }
        .mov-amount {
            font-family: 'Space Mono', monospace;
            font-weight: 500;
        }

        /* ============ ANNUAL SUMMARY ============ */
        .annual-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 14px;
        }
        @media (min-width: 600px) {
            .annual-grid { grid-template-columns: repeat(4, 1fr); }
        }
        .annual-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            text-align: center;
        }
        .annual-label { font-size: 11px; color: var(--text-muted); margin-bottom: 6px; }
        .annual-value {
            font-family: 'Space Mono', monospace;
            font-size: 16px;
            font-weight: 700;
        }

        /* ============ PAYMENT SUMMARY ============ */
        .payment-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        .payment-item {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 10px;
            font-size: 12px;
        }
        .payment-label { color: var(--text-muted); margin-bottom: 2px; }
        .payment-value {
            font-family: 'Space Mono', monospace;
            font-weight: 600;
        }

        /* ============ MODALS ============ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-modal);
            z-index: 1000;
            display: none;
            align-items: flex-end;
            justify-content: center;
            padding: 16px;
        }
        .modal-overlay.active { display: flex; }
        @media (min-width: 600px) {
            .modal-overlay { align-items: center; }
        }
        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        @media (min-width: 600px) {
            .modal { border-radius: 20px; }
        }
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }
        .modal-title { font-size: 16px; font-weight: 600; }
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: none;
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-body { padding: 20px; }
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
        }

        /* ============ FORMS ============ */
        .form-group {
            margin-bottom: 14px;
        }
        .form-label {
            display: block;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 6px;
        }
        .form-input, .form-select {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 14px;
            font-size: 14px;
            color: var(--text-primary);
            font-family: inherit;
            transition: all 0.2s;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--green);
            box-shadow: 0 0 0 3px var(--green-dim);
        }
        .form-input::placeholder { color: var(--text-muted); }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .amount-wrap { position: relative; }
        .amount-prefix {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-family: 'Space Mono', monospace;
        }
        .amount-input {
            padding-left: 32px;
            font-family: 'Space Mono', monospace;
            font-size: 20px;
            font-weight: 700;
        }

        /* Category Grid */
        .cat-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }
        .cat-pill {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px 4px;
            border-radius: 10px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }
        .cat-pill:hover { border-color: var(--border-light); }
        .cat-pill.active { border-color: var(--green); background: var(--green-dim); }
        .cat-pill input { display: none; }
        .cat-pill-icon { font-size: 18px; }
        .cat-pill-name { font-size: 9px; font-weight: 500; color: var(--text-secondary); }
        .cat-pill.active .cat-pill-name { color: var(--green); }

        /* Buttons */
        .btn {
            flex: 1;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-family: inherit;
            transition: all 0.2s;
        }
        .btn-primary {
            background: var(--green);
            color: #000;
        }
        .btn-primary:hover { background: var(--green-dark); }
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        .btn-danger {
            background: var(--red);
            color: #fff;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Add button */
        .add-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px;
            border-radius: 10px;
            background: var(--green-dim);
            border: 1px dashed var(--green);
            color: var(--green);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        .add-btn:hover { background: rgba(34,197,94,0.2); }

        /* ============ TOAST ============ */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: var(--green);
            color: #000;
            padding: 12px 22px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 13px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1001;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.error { background: var(--red); color: #fff; }

        /* ============ BOTTOM NAV ============ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 6px 0;
            padding-bottom: max(6px, env(safe-area-inset-bottom));
            z-index: 100;
        }
        .bnav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 6px 12px;
            color: var(--text-muted);
            background: none;
            border: none;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }
        .bnav-item.active { color: var(--green); }
        .bnav-item svg { width: 22px; height: 22px; }
        @media (min-width: 768px) {
            .bottom-nav { display: none; }
        }
        @media (max-width: 767px) {
            .nav { display: none; }
        }

        /* ============ EMPTY STATE ============ */
        .empty {
            text-align: center;
            padding: 40px 16px;
            color: var(--text-muted);
        }
        .empty p { font-size: 13px; }

        /* ============ DETAIL VIEW ============ */
        .detail-section {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 12px;
            margin-top: 10px;
        }
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }
        .detail-row:last-child { border: none; }
        .detail-label { color: var(--text-muted); }
        .detail-value { font-family: 'Space Mono', monospace; font-weight: 500; }
    </style>
</head>
<body>
    <!-- Ticker Bar -->
    <div class="ticker-bar">
        <div class="ticker-track" id="tickerTrack">
            <div class="ticker-group">
                <div class="ticker-item">
                    <span class="ticker-label">BTC</span>
                    <span class="ticker-value" id="tickerBTC">$--</span>
                    <span class="ticker-change" id="tickerBTCChange">--%</span>
                </div>
                <div class="ticker-item">
                    <span class="ticker-label">S&P 500</span>
                    <span class="ticker-value" id="tickerSP500">--</span>
                    <span class="ticker-change" id="tickerSP500Change">--%</span>
                </div>
                <div class="ticker-item">
                    <span class="ticker-label">D√≥lar BNA</span>
                    <span class="ticker-value" id="tickerUSD">$--</span>
                    <span class="ticker-change" id="tickerUSDChange">--%</span>
                </div>
                <div class="ticker-item">
                    <span class="ticker-label">Oro</span>
                    <span class="ticker-value" id="tickerGold">$--</span>
                    <span class="ticker-change" id="tickerGoldChange">--%</span>
                </div>
            </div>
            <div class="ticker-group">
                <div class="ticker-item">
                    <span class="ticker-label">BTC</span>
                    <span class="ticker-value ticker-btc-clone">$--</span>
                    <span class="ticker-change ticker-btc-change-clone">--%</span>
                </div>
                <div class="ticker-item">
                    <span class="ticker-label">S&P 500</span>
                    <span class="ticker-value ticker-sp500-clone">--</span>
                    <span class="ticker-change ticker-sp500-change-clone">--%</span>
                </div>
                <div class="ticker-item">
                    <span class="ticker-label">D√≥lar BNA</span>
                    <span class="ticker-value ticker-usd-clone">$--</span>
                    <span class="ticker-change ticker-usd-change-clone">--%</span>
                </div>
                <div class="ticker-item">
                    <span class="ticker-label">Oro</span>
                    <span class="ticker-value ticker-gold-clone">$--</span>
                    <span class="ticker-change ticker-gold-change-clone">--%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-inner">
            <div class="logo">
                <div class="logo-icon">üí∞</div>
                <span>ERP Lucas</span>
            </div>
            <div class="sync-badge">
                <span class="sync-dot" id="syncDot"></span>
                <span id="syncText">Sincronizado</span>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <button class="nav-btn active" data-view="dashboard">Dashboard</button>
        <button class="nav-btn" data-view="nuevo">+ Nuevo</button>
        <button class="nav-btn" data-view="historial">Historial</button>
        <button class="nav-btn" data-view="patrimonio">Patrimonio</button>
        <button class="nav-btn" data-view="anual">Resumen Anual</button>
    </nav>

    <!-- Main Content -->
    <main class="main" id="mainContent">
        <!-- Views se cargan din√°micamente -->
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="bnav-item active" data-view="dashboard">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
            Home
        </button>
        <button class="bnav-item" data-view="nuevo">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
            Nuevo
        </button>
        <button class="bnav-item" data-view="historial">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            Historial
        </button>
        <button class="bnav-item" data-view="patrimonio">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            Patrimonio
        </button>
        <button class="bnav-item" data-view="anual">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
            Anual
        </button>
    </nav>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Modal Container -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modalContent"></div>
    </div>

    <script>
    // ============================================================
    // CONFIGURACI√ìN Y ESTADO
    // ============================================================
    const CONFIG = {
        SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbyygKKwa1sK9CvQXtuckvJdv5EZAY2XS1BbSxpYMJXDMfGw_z4RSPUrGbZP61yMSUUx/exec', // URL del Google Apps Script
        VERSION: '2.0'
    };

    const CATS = {
        Comida: { icon: 'üçî', color: '#ef4444' },
        Servicios: { icon: '‚ö°', color: '#3b82f6' },
        Salidas: { icon: 'üéâ', color: '#a855f7' },
        Deporte: { icon: '‚öΩ', color: '#22c55e' },
        Regalos: { icon: 'üéÅ', color: '#eab308' },
        Educaci√≥n: { icon: 'üìö', color: '#06b6d4' },
        Tarjeta: { icon: 'üí≥', color: '#a855f7' },
        Otros: { icon: 'üì¶', color: '#737373' }
    };

    const PAYMENTS = ['D√©bito/Transferencia', 'VISA (8043)', 'MASTER (9714)', 'Efectivo'];
    const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

    // Estado global
    let state = {
        currentView: 'dashboard',
        currentMonth: new Date().getMonth(),
        currentYear: 2026,
        expenses: [],
        monthlyIncome: {}, // { "2026-01": 2981975.71 }
        patrimonio: {
            bbva: 4605.65,
            caja: 11050,
            efectivo: 1125
        },
        inversiones: [
            { id: 1, nombre: 'John Deere Credit', monto: 1000, tasa: 7, fechaCompra: '2026-01-13', vencimiento: '2027-01-13', frecuencia: 'Trimestral' },
            { id: 2, nombre: 'CRESUD', monto: 1500, tasa: 6.5, fechaCompra: '2026-01-14', vencimiento: '2027-01-14', frecuencia: 'Semestral' },
            { id: 3, nombre: 'SCANIA', monto: 500, tasa: 5.5, fechaCompra: '2026-01-13', vencimiento: '2027-01-13', frecuencia: 'Trimestral' }
        ],
        movimientos: [
            { id: 1, fecha: '2026-01-13', origen: 'BBVA', destino: 'John Deere Credit', monto: 1000, nota: 'Compra ON' },
            { id: 2, fecha: '2026-01-14', origen: 'BBVA', destino: 'Caja Seguridad', monto: 250, nota: 'Resguardo' },
            { id: 3, fecha: '2026-01-14', origen: 'BBVA', destino: 'CRESUD', monto: 1500, nota: 'Compra ON' }
        ],
        dolaresComprados: 0,
        dolaresGastados: 0,
        cotizaciones: {
            btc: { value: 0, change: 0 },
            sp500: { value: 0, change: 0 },
            usd: { value: 0, change: 0 },
            gold: { value: 0, change: 0 }
        }
    };

    const STORAGE_KEY = 'erp_lucas_v2';

    // ============================================================
    // ALMACENAMIENTO LOCAL
    // ============================================================
    function loadState() {
        try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                // Asegurar que los arrays existan
                state = { 
                    ...state, 
                    ...parsed,
                    expenses: Array.isArray(parsed.expenses) ? parsed.expenses : [],
                    inversiones: Array.isArray(parsed.inversiones) ? parsed.inversiones : state.inversiones,
                    movimientos: Array.isArray(parsed.movimientos) ? parsed.movimientos : state.movimientos,
                    monthlyIncome: parsed.monthlyIncome || {}
                };
            }
        } catch (e) {
            console.error('Error loading state:', e);
            // En caso de error, limpiar localStorage corrupto
            localStorage.removeItem(STORAGE_KEY);
        }
    }

    function saveState() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (e) {
            console.error('Error saving state:', e);
        }
    }

    // ============================================================
    // UTILIDADES
    // ============================================================
    function fmt(n, cur = 'ARS') {
        const prefix = cur === 'USD' ? 'U$S ' : '$';
        return prefix + Number(n || 0).toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
    }

    function fmtDate(d) {
        const dt = new Date(d);
        const today = new Date();
        if (dt.toDateString() === today.toDateString()) return 'Hoy';
        const yday = new Date(today);
        yday.setDate(yday.getDate() - 1);
        if (dt.toDateString() === yday.toDateString()) return 'Ayer';
        return dt.toLocaleDateString('es-AR', { day: '2-digit', month: 'short' });
    }

    function fmtShortDate(d) {
        return new Date(d).toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit' });
    }

    function getMonthKey(month, year) {
        return `${year}-${String(month + 1).padStart(2, '0')}`;
    }

    function getMonthIncome(month, year) {
        const key = getMonthKey(month, year);
        return state.monthlyIncome[key] || 0; // Default 0 hasta que el usuario lo cargue
    }

    function setMonthIncome(month, year, amount) {
        const key = getMonthKey(month, year);
        state.monthlyIncome[key] = amount;
        saveState();
    }

    function getMonthExpenses(month, year) {
        return state.expenses.filter(e => {
            const d = new Date(e.date);
            return d.getMonth() === month && d.getFullYear() === year;
        });
    }

    function getYearExpenses(year) {
        return state.expenses.filter(e => new Date(e.date).getFullYear() === year);
    }

    function getCatTotals(list) {
        const t = {};
        Object.keys(CATS).forEach(c => t[c] = 0);
        list.forEach(e => {
            const cat = e.category in CATS ? e.category : 'Otros';
            t[cat] += e.amount;
        });
        return t;
    }

    function getPaymentTotals(list) {
        const t = {};
        PAYMENTS.forEach(p => t[p] = 0);
        list.forEach(e => {
            const payment = e.payment || 'Efectivo';
            if (t[payment] !== undefined) t[payment] += e.amount;
            else t['Efectivo'] += e.amount;
        });
        return t;
    }

    function getTotalInversiones() {
        return state.inversiones.reduce((sum, inv) => sum + inv.monto, 0);
    }

    function getTotalPatrimonio() {
        return state.patrimonio.bbva + state.patrimonio.caja + state.patrimonio.efectivo + getTotalInversiones();
    }

    function toast(msg, isError = false) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.className = 'toast' + (isError ? ' error' : '');
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2500);
    }

    // ============================================================
    // COTIZACIONES EN TIEMPO REAL
    // ============================================================
    async function fetchCotizaciones() {
        try {
            // D√≥lar Argentina (API gratuita)
            const dolarRes = await fetch('https://dolarapi.com/v1/dolares/oficial');
            const dolarData = await dolarRes.json();
            state.cotizaciones.usd = {
                value: dolarData.venta || 0,
                change: 0
            };

            // Bitcoin (CoinGecko - gratuito)
            const btcRes = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true');
            const btcData = await btcRes.json();
            state.cotizaciones.btc = {
                value: btcData.bitcoin?.usd || 0,
                change: btcData.bitcoin?.usd_24h_change || 0
            };

            // S&P 500 y Oro - usar proxy o valores de referencia
            // Por ahora usamos valores de referencia actualizables
            state.cotizaciones.sp500 = { value: 6050, change: 0.5 };
            state.cotizaciones.gold = { value: 2750, change: 0.3 };

            updateTickerUI();
        } catch (e) {
            console.error('Error fetching cotizaciones:', e);
        }
    }

    function updateTickerUI() {
        const { btc, sp500, usd, gold } = state.cotizaciones;
        
        // Funci√≥n helper para actualizar elementos
        const updateEl = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        };
        
        const updateClass = (id, className) => {
            const el = document.getElementById(id);
            if (el) el.className = className;
        };
        
        // Actualizar principales
        updateEl('tickerBTC', '$' + btc.value.toLocaleString('en-US', { maximumFractionDigits: 0 }));
        updateEl('tickerBTCChange', (btc.change >= 0 ? '+' : '') + btc.change.toFixed(2) + '%');
        updateClass('tickerBTCChange', 'ticker-change ' + (btc.change >= 0 ? 'up' : 'down'));

        updateEl('tickerSP500', sp500.value.toLocaleString('en-US', { maximumFractionDigits: 0 }));
        updateEl('tickerSP500Change', (sp500.change >= 0 ? '+' : '') + sp500.change.toFixed(2) + '%');
        updateClass('tickerSP500Change', 'ticker-change ' + (sp500.change >= 0 ? 'up' : 'down'));

        updateEl('tickerUSD', '$' + usd.value.toLocaleString('es-AR', { maximumFractionDigits: 2 }));
        updateEl('tickerUSDChange', 'Oficial');

        updateEl('tickerGold', '$' + gold.value.toLocaleString('en-US', { maximumFractionDigits: 0 }));
        updateEl('tickerGoldChange', (gold.change >= 0 ? '+' : '') + gold.change.toFixed(2) + '%');
        updateClass('tickerGoldChange', 'ticker-change ' + (gold.change >= 0 ? 'up' : 'down'));

        // Actualizar clones
        document.querySelectorAll('.ticker-btc-clone').forEach(el => el.textContent = '$' + btc.value.toLocaleString('en-US', { maximumFractionDigits: 0 }));
        document.querySelectorAll('.ticker-btc-change-clone').forEach(el => {
            el.textContent = (btc.change >= 0 ? '+' : '') + btc.change.toFixed(2) + '%';
            el.className = 'ticker-change ticker-btc-change-clone ' + (btc.change >= 0 ? 'up' : 'down');
        });
        document.querySelectorAll('.ticker-sp500-clone').forEach(el => el.textContent = sp500.value.toLocaleString('en-US', { maximumFractionDigits: 0 }));
        document.querySelectorAll('.ticker-sp500-change-clone').forEach(el => {
            el.textContent = (sp500.change >= 0 ? '+' : '') + sp500.change.toFixed(2) + '%';
            el.className = 'ticker-change ticker-sp500-change-clone ' + (sp500.change >= 0 ? 'up' : 'down');
        });
        document.querySelectorAll('.ticker-usd-clone').forEach(el => el.textContent = '$' + usd.value.toLocaleString('es-AR', { maximumFractionDigits: 2 }));
        document.querySelectorAll('.ticker-usd-change-clone').forEach(el => el.textContent = 'Oficial');
        document.querySelectorAll('.ticker-gold-clone').forEach(el => el.textContent = '$' + gold.value.toLocaleString('en-US', { maximumFractionDigits: 0 }));
        document.querySelectorAll('.ticker-gold-change-clone').forEach(el => {
            el.textContent = (gold.change >= 0 ? '+' : '') + gold.change.toFixed(2) + '%';
            el.className = 'ticker-change ticker-gold-change-clone ' + (gold.change >= 0 ? 'up' : 'down');
        });
    }

    // ============================================================
    // SINCRONIZACI√ìN CON GOOGLE SHEETS
    // ============================================================
    async function syncWithSheets() {
        if (!CONFIG.SCRIPT_URL) {
            updateSyncStatus('offline');
            return;
        }

        updateSyncStatus('syncing');
        
        try {
            const response = await fetch(CONFIG.SCRIPT_URL + '?action=getAll');
            const data = await response.json();
            
            if (data.success) {
                if (data.expenses) state.expenses = data.expenses;
                if (data.patrimonio) state.patrimonio = { ...state.patrimonio, ...data.patrimonio };
                if (data.inversiones) state.inversiones = data.inversiones;
                if (data.monthlyIncome) state.monthlyIncome = data.monthlyIncome;
                saveState();
                updateSyncStatus('synced');
                renderCurrentView();
            }
        } catch (e) {
            console.error('Sync error:', e);
            updateSyncStatus('error');
        }
    }

    async function saveToSheets(action, data) {
        if (!CONFIG.SCRIPT_URL) return true;

        try {
            const response = await fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action, data })
            });
            const result = await response.json();
            return result.success;
        } catch (e) {
            console.error('Save error:', e);
            return false;
        }
    }

    function updateSyncStatus(status) {
        const dot = document.getElementById('syncDot');
        const text = document.getElementById('syncText');
        
        dot.className = 'sync-dot';
        switch (status) {
            case 'syncing':
                dot.classList.add('syncing');
                text.textContent = 'Sincronizando...';
                break;
            case 'synced':
                text.textContent = 'Sincronizado';
                break;
            case 'error':
                dot.classList.add('error');
                text.textContent = 'Error';
                break;
            default:
                text.textContent = 'Offline';
        }
    }

    // ============================================================
    // NAVEGACI√ìN
    // ============================================================
    function switchView(view) {
        state.currentView = view;
        
        document.querySelectorAll('.nav-btn, .bnav-item').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.view === view);
        });

        renderCurrentView();
    }

    function renderCurrentView() {
        const main = document.getElementById('mainContent');
        
        switch (state.currentView) {
            case 'dashboard':
                main.innerHTML = renderDashboard();
                initDashboardEvents();
                break;
            case 'nuevo':
                main.innerHTML = renderNuevoGasto();
                initNuevoGastoEvents();
                break;
            case 'historial':
                main.innerHTML = renderHistorial();
                initHistorialEvents();
                break;
            case 'patrimonio':
                main.innerHTML = renderPatrimonio();
                initPatrimonioEvents();
                break;
            case 'anual':
                main.innerHTML = renderAnual();
                initAnualEvents();
                break;
        }
    }

    // ============================================================
    // RENDER: DASHBOARD
    // ============================================================
    function renderDashboard() {
        const list = getMonthExpenses(state.currentMonth, state.currentYear);
        const income = getMonthIncome(state.currentMonth, state.currentYear);
        const totalGastos = list.reduce((s, e) => s + (e.currency === 'ARS' ? e.amount : 0), 0);
        const totalGastosUSD = list.reduce((s, e) => s + (e.currency === 'USD' ? e.amount : 0), 0);
        const tarjeta = list.filter(e => e.payment?.includes('VISA') || e.payment?.includes('MASTER')).reduce((s, e) => s + e.amount, 0);
        const balance = income - totalGastos;

        const catTotals = getCatTotals(list);
        const paymentTotals = getPaymentTotals(list);

        return `
            <div class="view active" id="dashboardView">
                <div class="month-sel">
                    <button class="month-btn" id="prevMonth">‚Äπ</button>
                    <span class="month-display" id="monthDisplay">${MONTHS[state.currentMonth]} ${state.currentYear}</span>
                    <button class="month-btn" id="nextMonth">‚Ä∫</button>
                    <button class="edit-income-btn" id="editIncomeBtn">‚úèÔ∏è Ingreso</button>
                </div>

                <div class="kpi-grid">
                    <div class="kpi" data-detail="ingresos">
                        <div class="kpi-label">üíµ Ingresos</div>
                        <div class="kpi-value" style="color:var(--green)">${fmt(income)}</div>
                    </div>
                    <div class="kpi" data-detail="gastos">
                        <div class="kpi-label">üìâ Gastos</div>
                        <div class="kpi-value" style="color:var(--red)">${fmt(totalGastos)}</div>
                    </div>
                    <div class="kpi" data-detail="balance">
                        <div class="kpi-label">üìä Balance</div>
                        <div class="kpi-value" style="color:${balance >= 0 ? 'var(--green)' : 'var(--red)'}">${fmt(balance)}</div>
                    </div>
                    <div class="kpi" data-detail="tarjeta">
                        <div class="kpi-label">üí≥ Tarjeta</div>
                        <div class="kpi-value" style="color:var(--yellow)">${fmt(tarjeta)}</div>
                    </div>
                </div>

                <div class="charts-row">
                    <div class="card">
                        <div class="card-title">Por Categor√≠a</div>
                        <div class="chart-box"><canvas id="catChart"></canvas></div>
                    </div>
                    <div class="card">
                        <div class="card-title">Evoluci√≥n Mensual</div>
                        <div class="chart-box"><canvas id="monthChart"></canvas></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Por Medio de Pago</div>
                    <div class="payment-summary">
                        ${PAYMENTS.map(p => `
                            <div class="payment-item">
                                <div class="payment-label">${p}</div>
                                <div class="payment-value">${fmt(paymentTotals[p])}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="card">
                    <div class="tx-header">
                        <span class="tx-title">√öltimos Movimientos</span>
                        <button class="tx-more" onclick="switchView('historial')">Ver todos ‚Üí</button>
                    </div>
                    <div class="tx-list" id="recentTx">
                        ${renderTransactionList(list.slice(0, 5))}
                    </div>
                </div>
            </div>
        `;
    }

    function initDashboardEvents() {
        document.getElementById('prevMonth')?.addEventListener('click', () => {
            state.currentMonth--;
            if (state.currentMonth < 0) { state.currentMonth = 11; state.currentYear--; }
            renderCurrentView();
        });

        document.getElementById('nextMonth')?.addEventListener('click', () => {
            state.currentMonth++;
            if (state.currentMonth > 11) { state.currentMonth = 0; state.currentYear++; }
            renderCurrentView();
        });

        document.getElementById('editIncomeBtn')?.addEventListener('click', () => {
            showIncomeModal();
        });

        // KPI click for details
        document.querySelectorAll('.kpi[data-detail]').forEach(kpi => {
            kpi.addEventListener('click', () => showKPIDetail(kpi.dataset.detail));
        });

        // Render charts
        renderCategoryChart();
        renderMonthlyChart();
    }

    function renderCategoryChart() {
        const ctx = document.getElementById('catChart')?.getContext('2d');
        if (!ctx) return;

        const list = getMonthExpenses(state.currentMonth, state.currentYear);
        const totals = getCatTotals(list);
        const labels = Object.keys(totals).filter(k => totals[k] > 0);
        const data = labels.map(k => totals[k]);
        const colors = labels.map(k => CATS[k]?.color || '#737373');

        if (window.catChartInstance) window.catChartInstance.destroy();
        
        window.catChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0 }] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { color: '#a3a3a3', font: { family: 'Inter', size: 11 }, padding: 8, usePointStyle: true }
                    }
                },
                cutout: '60%'
            }
        });
    }

    function renderMonthlyChart() {
        const ctx = document.getElementById('monthChart')?.getContext('2d');
        if (!ctx) return;

        const data = [];
        for (let i = 0; i < 12; i++) {
            data.push(getMonthExpenses(i, state.currentYear).reduce((s, e) => s + e.amount, 0));
        }

        if (window.monthChartInstance) window.monthChartInstance.destroy();

        window.monthChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: MONTHS.map(m => m.substring(0, 3)),
                datasets: [{
                    data,
                    backgroundColor: data.map((_, i) => i === state.currentMonth ? '#22c55e' : '#3b82f6'),
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { color: '#737373', font: { size: 10 } } },
                    y: { grid: { color: '#262626' }, ticks: { color: '#737373', callback: v => '$' + (v/1000).toFixed(0) + 'k' } }
                }
            }
        });
    }

    // ============================================================
    // RENDER: NUEVO GASTO
    // ============================================================
    function renderNuevoGasto() {
        return `
            <div class="view active" id="nuevoView">
                <div class="card">
                    <h2 style="font-size:16px;font-weight:600;margin-bottom:18px;">‚ûï Registrar Gasto</h2>
                    <form id="expenseForm">
                        <div class="form-group">
                            <label class="form-label">Monto</label>
                            <div class="amount-wrap">
                                <span class="amount-prefix">$</span>
                                <input type="number" class="form-input amount-input" id="amount" placeholder="0" required step="0.01" inputmode="decimal">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Categor√≠a</label>
                            <div class="cat-grid">
                                ${Object.entries(CATS).map(([name, { icon }], i) => `
                                    <label class="cat-pill${i === 0 ? ' active' : ''}">
                                        <input type="radio" name="cat" value="${name}" ${i === 0 ? 'checked' : ''}>
                                        <span class="cat-pill-icon">${icon}</span>
                                        <span class="cat-pill-name">${name}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Moneda</label>
                                <select class="form-select" id="currency">
                                    <option value="ARS">ARS</option>
                                    <option value="USD">USD</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Medio de Pago</label>
                                <select class="form-select" id="payment">
                                    ${PAYMENTS.map(p => `<option value="${p}">${p}</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Descripci√≥n</label>
                            <input type="text" class="form-input" id="desc" placeholder="¬øEn qu√© gastaste?">
                        </div>

                        <button type="submit" class="btn btn-primary" style="width:100%;margin-top:8px" id="submitBtn">
                            Guardar Gasto
                        </button>
                    </form>
                </div>
            </div>
        `;
    }

    function initNuevoGastoEvents() {
        document.querySelectorAll('.cat-pill').forEach(pill => {
            pill.addEventListener('click', () => {
                document.querySelectorAll('.cat-pill').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
            });
        });

        document.getElementById('expenseForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = 'Guardando...';

            const expense = {
                id: Date.now(),
                date: new Date().toISOString(),
                amount: parseFloat(document.getElementById('amount').value),
                category: document.querySelector('input[name="cat"]:checked').value,
                currency: document.getElementById('currency').value,
                payment: document.getElementById('payment').value,
                description: document.getElementById('desc').value.trim()
            };

            state.expenses.unshift(expense);
            saveState();
            await saveToSheets('addExpense', expense);

            toast('‚úì Gasto guardado');
            document.getElementById('amount').value = '';
            document.getElementById('desc').value = '';
            btn.disabled = false;
            btn.textContent = 'Guardar Gasto';
        });
    }

    // ============================================================
    // RENDER: HISTORIAL
    // ============================================================
    function renderHistorial() {
        // Ordenar por fecha m√°s reciente
        const sortedExpenses = [...state.expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
        
        return `
            <div class="view active" id="historialView">
                <div class="tabs">
                    <button class="tab active" data-currency="all">Todos</button>
                    <button class="tab" data-currency="ARS">ARS</button>
                    <button class="tab" data-currency="USD">USD</button>
                </div>

                <div class="filters" id="filters">
                    <button class="filter-chip active" data-filter="all">Todos</button>
                    ${Object.entries(CATS).map(([name, { icon }]) => `
                        <button class="filter-chip" data-filter="${name}">${icon} ${name}</button>
                    `).join('')}
                </div>

                <div class="card">
                    <div class="tx-list" id="historialList">
                        ${sortedExpenses.length > 0 ? renderTransactionList(sortedExpenses.slice(0, 50), true) : '<div class="empty"><p>No hay gastos registrados</p></div>'}
                    </div>
                </div>
            </div>
        `;
    }

    function initHistorialEvents() {
        let currentCurrency = 'all';
        let currentFilter = 'all';

        function updateList() {
            let list = [...state.expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (currentCurrency !== 'all') {
                list = list.filter(e => e.currency === currentCurrency);
            }
            if (currentFilter !== 'all') {
                list = list.filter(e => e.category === currentFilter);
            }
            
            const container = document.getElementById('historialList');
            if (container) {
                container.innerHTML = list.length > 0 ? renderTransactionList(list.slice(0, 50), true) : '<div class="empty"><p>No hay gastos en este filtro</p></div>';
                initSwipeDelete();
            }
        }

        document.querySelectorAll('#historialView .tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('#historialView .tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentCurrency = tab.dataset.currency;
                updateList();
            });
        });

        document.querySelectorAll('#historialView .filter-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                document.querySelectorAll('#historialView .filter-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                currentFilter = chip.dataset.filter;
                updateList();
            });
        });

        initSwipeDelete();
    }

    function renderTransactionList(list, swipeable = false) {
        if (!list.length) {
            return '<div class="empty"><p>No hay gastos</p></div>';
        }

        return list.map(e => `
            <div class="tx-item${swipeable ? ' swipeable' : ''}" data-id="${e.id}">
                ${swipeable ? '<div class="tx-delete-bg">üóëÔ∏è</div>' : ''}
                <div class="tx-icon cat-${(e.category || 'otros').toLowerCase()}">${CATS[e.category]?.icon || 'üì¶'}</div>
                <div class="tx-info">
                    <div class="tx-desc">${e.description || e.category}</div>
                    <div class="tx-meta">${fmtDate(e.date)} ¬∑ ${e.payment || 'Efectivo'}</div>
                </div>
                <div class="tx-amount" style="color:var(--red)">-${fmt(e.amount, e.currency)}</div>
            </div>
        `).join('');
    }

    function initSwipeDelete() {
        document.querySelectorAll('.tx-item.swipeable').forEach(item => {
            let startX = 0;
            let currentX = 0;
            let swiped = false;

            item.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
            });

            item.addEventListener('touchmove', (e) => {
                currentX = e.touches[0].clientX;
                const diff = currentX - startX;
                if (diff > 50 && !swiped) {
                    item.classList.add('swiped');
                    swiped = true;
                }
            });

            item.addEventListener('touchend', () => {
                if (swiped) {
                    setTimeout(() => {
                        if (confirm('¬øEliminar este gasto?')) {
                            const id = parseInt(item.dataset.id);
                            state.expenses = state.expenses.filter(e => e.id !== id);
                            saveState();
                            item.remove();
                            toast('Gasto eliminado');
                        } else {
                            item.classList.remove('swiped');
                            swiped = false;
                        }
                    }, 100);
                }
            });

            // Click para editar
            item.addEventListener('click', (e) => {
                if (!swiped) {
                    const id = parseInt(item.dataset.id);
                    showEditExpenseModal(id);
                }
            });
        });
    }

    // ============================================================
    // RENDER: PATRIMONIO
    // ============================================================
    function renderPatrimonio() {
        const total = getTotalPatrimonio();
        const totalInv = getTotalInversiones();

        return `
            <div class="view active" id="patrimonioView">
                <div class="pat-total">
                    <div class="pat-total-label">Patrimonio Total USD</div>
                    <div class="pat-total-value">${fmt(total, 'USD')}</div>
                </div>

                <div class="pat-grid">
                    <div class="pat-card" data-account="bbva">
                        <div class="pat-label">BBVA</div>
                        <div class="pat-value">${fmt(state.patrimonio.bbva, 'USD')}</div>
                        <div class="pat-detail">
                            <div style="display:flex;gap:8px;flex-wrap:wrap">
                                <button class="add-btn" style="flex:1;min-width:120px" onclick="showTransferModal('bbva')">‚ÜîÔ∏è Mover</button>
                                <button class="add-btn" style="flex:1;min-width:120px;border-color:var(--red);color:var(--red);background:var(--red-dim)" onclick="showWithdrawModal('bbva')">üì§ Retirar</button>
                                <button class="add-btn" style="flex:1;min-width:120px;border-color:var(--green);color:var(--green)" onclick="showDepositModal('bbva')">üì• Ingresar</button>
                            </div>
                        </div>
                    </div>
                    <div class="pat-card" data-account="caja">
                        <div class="pat-label">Caja Seguridad</div>
                        <div class="pat-value">${fmt(state.patrimonio.caja, 'USD')}</div>
                        <div class="pat-detail">
                            <div style="display:flex;gap:8px;flex-wrap:wrap">
                                <button class="add-btn" style="flex:1;min-width:120px" onclick="showTransferModal('caja')">‚ÜîÔ∏è Mover</button>
                                <button class="add-btn" style="flex:1;min-width:120px;border-color:var(--red);color:var(--red);background:var(--red-dim)" onclick="showWithdrawModal('caja')">üì§ Retirar</button>
                                <button class="add-btn" style="flex:1;min-width:120px;border-color:var(--green);color:var(--green)" onclick="showDepositModal('caja')">üì• Ingresar</button>
                            </div>
                        </div>
                    </div>
                    <div class="pat-card" data-account="efectivo">
                        <div class="pat-label">Efectivo</div>
                        <div class="pat-value">${fmt(state.patrimonio.efectivo, 'USD')}</div>
                        <div class="pat-detail">
                            <div style="display:flex;gap:8px;flex-wrap:wrap">
                                <button class="add-btn" style="flex:1;min-width:120px" onclick="showTransferModal('efectivo')">‚ÜîÔ∏è Mover</button>
                                <button class="add-btn" style="flex:1;min-width:120px;border-color:var(--red);color:var(--red);background:var(--red-dim)" onclick="showWithdrawModal('efectivo')">üì§ Retirar</button>
                                <button class="add-btn" style="flex:1;min-width:120px;border-color:var(--green);color:var(--green)" onclick="showDepositModal('efectivo')">üì• Ingresar</button>
                            </div>
                        </div>
                    </div>
                    <div class="pat-card" data-account="inversiones">
                        <div class="pat-label">Inversiones (ONs)</div>
                        <div class="pat-value">${fmt(totalInv, 'USD')}</div>
                        <div class="pat-detail">
                            <div class="inv-list">
                                ${state.inversiones.length > 0 ? state.inversiones.map(inv => `
                                    <div class="inv-item" data-inv-id="${inv.id}">
                                        <div class="inv-header">
                                            <span class="inv-name">${inv.nombre}</span>
                                            <span class="inv-amount">${fmt(inv.monto, 'USD')}</span>
                                        </div>
                                        <div class="inv-details">
                                            <div class="inv-detail-row">
                                                <span>Tasa anual</span>
                                                <span>${inv.tasa}%</span>
                                            </div>
                                            <div class="inv-detail-row">
                                                <span>Fecha compra</span>
                                                <span>${fmtShortDate(inv.fechaCompra)}</span>
                                            </div>
                                            <div class="inv-detail-row">
                                                <span>Vencimiento</span>
                                                <span>${fmtShortDate(inv.vencimiento)}</span>
                                            </div>
                                            <div class="inv-detail-row">
                                                <span>Pago intereses</span>
                                                <span>${inv.frecuencia}</span>
                                            </div>
                                            <div class="inv-detail-row">
                                                <span>Origen</span>
                                                <span>${inv.origen || 'No especificado'}</span>
                                            </div>
                                            <div class="inv-actions">
                                                <button class="inv-action-btn edit" onclick="event.stopPropagation();showEditInversionModal(${inv.id})">‚úèÔ∏è Editar</button>
                                                <button class="inv-action-btn delete" onclick="event.stopPropagation();deleteInversion(${inv.id})">üóëÔ∏è Eliminar</button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('') : '<div class="empty"><p>No hay inversiones</p></div>'}
                            </div>
                            <button class="add-btn" style="margin-top:10px" onclick="showAddInversionModal()">+ Agregar inversi√≥n</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Evoluci√≥n del Patrimonio</div>
                    <div class="chart-box"><canvas id="patChart"></canvas></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Historial de Movimientos</span>
                    </div>
                    <div class="mov-list">
                        ${state.movimientos.length > 0 ? state.movimientos.slice(0, 10).map(m => `
                            <div class="mov-item">
                                <span class="mov-date">${fmtShortDate(m.fecha)}</span>
                                <span class="mov-desc">${m.origen} ‚Üí ${m.destino}</span>
                                <span class="mov-amount" style="color:${m.destino === 'GASTO' ? 'var(--red)' : 'var(--blue)'}">${m.destino === 'GASTO' ? '-' : ''}${fmt(m.monto, 'USD')}</span>
                            </div>
                        `).join('') : '<div class="empty"><p>No hay movimientos</p></div>'}
                    </div>
                </div>
            </div>
        `;
    }

    function initPatrimonioEvents() {
        // Expandir/contraer cuentas
        document.querySelectorAll('.pat-card').forEach(card => {
            card.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') return;
                card.classList.toggle('expanded');
            });
        });

        // Expandir/contraer inversiones
        document.querySelectorAll('.inv-item').forEach(item => {
            item.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') return;
                item.classList.toggle('expanded');
            });
        });

        renderPatrimonioChart();
    }

    function renderPatrimonioChart() {
        const ctx = document.getElementById('patChart')?.getContext('2d');
        if (!ctx) return;

        // Datos de ejemplo - en producci√≥n vendr√≠an del historial
        const evolutionData = [17000, 17500, 18000, 18500, 19000, 19500, getTotalPatrimonio()];

        if (window.patChartInstance) window.patChartInstance.destroy();

        window.patChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic', 'Ene'],
                datasets: [{
                    data: evolutionData,
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34,197,94,0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: '#22c55e'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { color: '#737373' } },
                    y: { grid: { color: '#262626' }, ticks: { color: '#737373', callback: v => 'U$S ' + (v/1000).toFixed(0) + 'k' } }
                }
            }
        });
    }

    // ============================================================
    // RENDER: RESUMEN ANUAL
    // ============================================================
    function renderAnual() {
        const yearExpenses = getYearExpenses(state.currentYear);
        const totalGastos = yearExpenses.reduce((s, e) => s + e.amount, 0);
        // Solo sumar los ingresos que el usuario haya cargado (sin fallback)
        const totalIngresos = Object.entries(state.monthlyIncome)
            .filter(([k]) => k.startsWith(state.currentYear.toString()))
            .reduce((s, [, v]) => s + v, 0);
        
        const gastosUSD = yearExpenses.filter(e => e.currency === 'USD').reduce((s, e) => s + e.amount, 0);

        return `
            <div class="view active" id="anualView">
                <div class="month-sel" style="justify-content:center;margin-bottom:20px">
                    <button class="month-btn" onclick="changeYear(-1)">‚Äπ</button>
                    <span class="month-display">${state.currentYear}</span>
                    <button class="month-btn" onclick="changeYear(1)">‚Ä∫</button>
                </div>

                <div class="annual-grid">
                    <div class="annual-card">
                        <div class="annual-label">Total Ingresos</div>
                        <div class="annual-value" style="color:var(--green)">${fmt(totalIngresos)}</div>
                    </div>
                    <div class="annual-card">
                        <div class="annual-label">Total Gastos</div>
                        <div class="annual-value" style="color:var(--red)">${fmt(totalGastos)}</div>
                    </div>
                    <div class="annual-card">
                        <div class="annual-label">Ahorro ARS</div>
                        <div class="annual-value" style="color:var(--blue)">${fmt(totalIngresos - totalGastos)}</div>
                    </div>
                    <div class="annual-card">
                        <div class="annual-label">Gastos USD</div>
                        <div class="annual-value" style="color:var(--yellow)">${fmt(gastosUSD, 'USD')}</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">D√≥lares Netos</div>
                    <div style="text-align:center;padding:20px 0">
                        <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">Comprados - Gastados</div>
                        <div style="font-family:'Space Mono';font-size:28px;font-weight:700;color:var(--green)">
                            ${fmt(state.dolaresComprados - gastosUSD, 'USD')}
                        </div>
                        <div style="margin-top:16px;display:flex;justify-content:center;gap:24px;font-size:13px">
                            <div>
                                <span style="color:var(--text-muted)">Comprados:</span>
                                <span style="color:var(--green);font-family:'Space Mono'">${fmt(state.dolaresComprados, 'USD')}</span>
                            </div>
                            <div>
                                <span style="color:var(--text-muted)">Gastados:</span>
                                <span style="color:var(--red);font-family:'Space Mono'">${fmt(gastosUSD, 'USD')}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Evoluci√≥n Mensual ${state.currentYear}</div>
                    <div class="chart-box"><canvas id="anualChart"></canvas></div>
                </div>

                <div class="card">
                    <div class="card-title">Gastos por Categor√≠a (Anual)</div>
                    <div class="detail-section">
                        ${Object.entries(getCatTotals(yearExpenses)).filter(([,v]) => v > 0).map(([cat, total]) => `
                            <div class="detail-row">
                                <span>${CATS[cat]?.icon || 'üì¶'} ${cat}</span>
                                <span class="detail-value">${fmt(total)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }

    function initAnualEvents() {
        renderAnualChart();
    }

    function renderAnualChart() {
        const ctx = document.getElementById('anualChart')?.getContext('2d');
        if (!ctx) return;

        const gastosData = [];
        const ingresosData = [];
        
        for (let i = 0; i < 12; i++) {
            gastosData.push(getMonthExpenses(i, state.currentYear).reduce((s, e) => s + e.amount, 0));
            ingresosData.push(getMonthIncome(i, state.currentYear));
        }

        if (window.anualChartInstance) window.anualChartInstance.destroy();

        window.anualChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: MONTHS.map(m => m.substring(0, 3)),
                datasets: [
                    { label: 'Ingresos', data: ingresosData, backgroundColor: '#22c55e', borderRadius: 4 },
                    { label: 'Gastos', data: gastosData, backgroundColor: '#ef4444', borderRadius: 4 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#a3a3a3' } } },
                scales: {
                    x: { grid: { display: false }, ticks: { color: '#737373', font: { size: 10 } } },
                    y: { grid: { color: '#262626' }, ticks: { color: '#737373', callback: v => '$' + (v/1000000).toFixed(1) + 'M' } }
                }
            }
        });
    }

    window.changeYear = function(delta) {
        state.currentYear += delta;
        renderCurrentView();
    };

    // ============================================================
    // MODALES
    // ============================================================
    function showModal(content) {
        document.getElementById('modalContent').innerHTML = content;
        document.getElementById('modalOverlay').classList.add('active');
    }

    function hideModal() {
        document.getElementById('modalOverlay').classList.remove('active');
    }

    document.getElementById('modalOverlay')?.addEventListener('click', (e) => {
        if (e.target === document.getElementById('modalOverlay')) hideModal();
    });

    // Modal: Editar Ingreso
    function showIncomeModal() {
        const current = getMonthIncome(state.currentMonth, state.currentYear);
        showModal(`
            <div class="modal-header">
                <span class="modal-title">Editar Ingreso - ${MONTHS[state.currentMonth]}</span>
                <button class="modal-close" onclick="hideModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Monto</label>
                    <div class="amount-wrap">
                        <span class="amount-prefix">$</span>
                        <input type="number" class="form-input amount-input" id="incomeAmount" value="${current}" step="0.01">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveIncome()">Guardar</button>
            </div>
        `);
    }

    window.saveIncome = function() {
        const amount = parseFloat(document.getElementById('incomeAmount').value);
        setMonthIncome(state.currentMonth, state.currentYear, amount);
        hideModal();
        renderCurrentView();
        toast('Ingreso actualizado');
    };

    // Modal: Editar Gasto
    function showEditExpenseModal(id) {
        const expense = state.expenses.find(e => e.id === id);
        if (!expense) return;

        showModal(`
            <div class="modal-header">
                <span class="modal-title">Editar Gasto</span>
                <button class="modal-close" onclick="hideModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Monto</label>
                    <div class="amount-wrap">
                        <span class="amount-prefix">$</span>
                        <input type="number" class="form-input amount-input" id="editAmount" value="${expense.amount}" step="0.01">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Categor√≠a</label>
                    <select class="form-select" id="editCategory">
                        ${Object.keys(CATS).map(c => `<option value="${c}" ${expense.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Descripci√≥n</label>
                    <input type="text" class="form-input" id="editDesc" value="${expense.description || ''}">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteExpense(${id})">Eliminar</button>
                <button class="btn btn-primary" onclick="saveExpenseEdit(${id})">Guardar</button>
            </div>
        `);
    }

    window.saveExpenseEdit = function(id) {
        const expense = state.expenses.find(e => e.id === id);
        if (expense) {
            expense.amount = parseFloat(document.getElementById('editAmount').value);
            expense.category = document.getElementById('editCategory').value;
            expense.description = document.getElementById('editDesc').value;
            saveState();
            hideModal();
            renderCurrentView();
            toast('Gasto actualizado');
        }
    };

    window.deleteExpense = function(id) {
        if (confirm('¬øEliminar este gasto?')) {
            state.expenses = state.expenses.filter(e => e.id !== id);
            saveState();
            hideModal();
            renderCurrentView();
            toast('Gasto eliminado');
        }
    };

    // Modal: KPI Detail
    function showKPIDetail(type) {
        const list = getMonthExpenses(state.currentMonth, state.currentYear);
        let content = '';

        switch (type) {
            case 'gastos':
                const catTotals = getCatTotals(list);
                content = `
                    <div class="modal-header">
                        <span class="modal-title">Detalle de Gastos</span>
                        <button class="modal-close" onclick="hideModal()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="detail-section">
                            ${Object.entries(catTotals).filter(([,v]) => v > 0).map(([cat, total]) => `
                                <div class="detail-row">
                                    <span>${CATS[cat]?.icon || 'üì¶'} ${cat}</span>
                                    <span class="detail-value">${fmt(total)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                break;
            case 'tarjeta':
                const visaTotal = list.filter(e => e.payment?.includes('VISA')).reduce((s, e) => s + e.amount, 0);
                const masterTotal = list.filter(e => e.payment?.includes('MASTER')).reduce((s, e) => s + e.amount, 0);
                content = `
                    <div class="modal-header">
                        <span class="modal-title">Detalle de Tarjeta</span>
                        <button class="modal-close" onclick="hideModal()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="detail-section">
                            <div class="detail-row">
                                <span>üí≥ VISA (8043)</span>
                                <span class="detail-value">${fmt(visaTotal)}</span>
                            </div>
                            <div class="detail-row">
                                <span>üí≥ MASTER (9714)</span>
                                <span class="detail-value">${fmt(masterTotal)}</span>
                            </div>
                        </div>
                    </div>
                `;
                break;
            default:
                return;
        }

        showModal(content);
    }

    // Modal: Transfer
    window.showTransferModal = function(from) {
        const accounts = ['bbva', 'caja', 'efectivo'].filter(a => a !== from);
        const accountNames = { bbva: 'BBVA', caja: 'Caja Seguridad', efectivo: 'Efectivo' };
        showModal(`
            <div class="modal-header">
                <span class="modal-title">Mover Fondos</span>
                <button class="modal-close" onclick="hideModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Desde</label>
                    <input type="text" class="form-input" value="${accountNames[from]}" disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">Hacia</label>
                    <select class="form-select" id="transferTo">
                        ${accounts.map(a => `<option value="${a}">${accountNames[a]}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Monto USD</label>
                    <div class="amount-wrap">
                        <span class="amount-prefix">$</span>
                        <input type="number" class="form-input amount-input" id="transferAmount" step="0.01">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Nota</label>
                    <input type="text" class="form-input" id="transferNote" placeholder="Ej: Resguardo mensual">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="executeTransfer('${from}')">Transferir</button>
            </div>
        `);
    };

    // Modal: Retirar (gasto/salida)
    window.showWithdrawModal = function(from) {
        const accountNames = { bbva: 'BBVA', caja: 'Caja Seguridad', efectivo: 'Efectivo' };
        showModal(`
            <div class="modal-header">
                <span class="modal-title">Retirar de ${accountNames[from]}</span>
                <button class="modal-close" onclick="hideModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="font-size:13px;color:var(--text-muted);margin-bottom:14px">Registrar un gasto o retiro de USD</p>
                <div class="form-group">
                    <label class="form-label">Monto USD</label>
                    <div class="amount-wrap">
                        <span class="amount-prefix">$</span>
                        <input type="number" class="form-input amount-input" id="withdrawAmount" step="0.01">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Motivo</label>
                    <input type="text" class="form-input" id="withdrawNote" placeholder="Ej: Gasto en viaje, Compra X...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal()">Cancelar</button>
                <button class="btn btn-danger" onclick="executeWithdraw('${from}')">Retirar</button>
            </div>
        `);
    };

    window.executeWithdraw = function(from) {
        const amount = parseFloat(document.getElementById('withdrawAmount').value);
        const note = document.getElementById('withdrawNote').value || 'Retiro/Gasto';

        if (!amount || amount <= 0) {
            toast('Ingres√° un monto v√°lido', true);
            return;
        }

        if (state.patrimonio[from] < amount) {
            toast('Saldo insuficiente', true);
            return;
        }

        state.patrimonio[from] -= amount;
        state.dolaresGastados += amount;

        state.movimientos.unshift({
            id: Date.now(),
            fecha: new Date().toISOString().split('T')[0],
            origen: from.toUpperCase(),
            destino: 'GASTO',
            monto: amount,
            nota: note
        });

        saveState();
        hideModal();
        renderCurrentView();
        toast('Retiro registrado');
    };

    // Modal: Depositar (ingreso)
    window.showDepositModal = function(to) {
        const accountNames = { bbva: 'BBVA', caja: 'Caja Seguridad', efectivo: 'Efectivo' };
        showModal(`
            <div class="modal-header">
                <span class="modal-title">Ingresar a ${accountNames[to]}</span>
                <button class="modal-close" onclick="hideModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="font-size:13px;color:var(--text-muted);margin-bottom:14px">Registrar ingreso de USD (compra de d√≥lares, etc.)</p>
                <div class="form-group">
                    <label class="form-label">Monto USD</label>
                    <div class="amount-wrap">
                        <span class="amount-prefix">$</span>
                        <input type="number" class="form-input amount-input" id="depositAmount" step="0.01">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Motivo</label>
                    <input type="text" class="form-input" id="depositNote" placeholder="Ej: Compra de d√≥lares, Cobro...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="executeDeposit('${to}')">Ingresar</button>
            </div>
        `);
    };

    window.executeDeposit = function(to) {
        const amount = parseFloat(document.getElementById('depositAmount').value);
        const note = document.getElementById('depositNote').value || 'Ingreso';

        if (!amount || amount <= 0) {
            toast('Ingres√° un monto v√°lido', true);
            return;
        }

        state.patrimonio[to] += amount;
        state.dolaresComprados += amount;

        state.movimientos.unshift({
            id: Date.now(),
            fecha: new Date().toISOString().split('T')[0],
            origen: 'INGRESO',
            destino: to.toUpperCase(),
            monto: amount,
            nota: note
        });

        saveState();
        hideModal();
        renderCurrentView();
        toast('Ingreso registrado');
    };

    window.executeTransfer = function(from) {
        const to = document.getElementById('transferTo').value;
        const amount = parseFloat(document.getElementById('transferAmount').value);
        const note = document.getElementById('transferNote').value || 'Transferencia';
        const accountNames = { bbva: 'BBVA', caja: 'Caja Seguridad', efectivo: 'Efectivo' };

        if (!amount || amount <= 0) {
            toast('Ingres√° un monto v√°lido', true);
            return;
        }

        if (state.patrimonio[from] < amount) {
            toast('Saldo insuficiente', true);
            return;
        }

        // Ejecutar transferencia
        state.patrimonio[from] -= amount;
        state.patrimonio[to] += amount;

        // Registrar movimiento
        state.movimientos.unshift({
            id: Date.now(),
            fecha: new Date().toISOString().split('T')[0],
            origen: accountNames[from],
            destino: accountNames[to],
            monto: amount,
            nota: note
        });

        saveState();
        hideModal();
        renderCurrentView();
        toast('Transferencia realizada');
    };

    // Modal: Add Inversi√≥n
    window.showAddInversionModal = function() {
        showModal(`
            <div class="modal-header">
                <span class="modal-title">Nueva Inversi√≥n</span>
                <button class="modal-close" onclick="hideModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nombre</label>
                    <input type="text" class="form-input" id="invNombre" placeholder="Ej: CRESUD ON">
                </div>
                <div class="form-group">
                    <label class="form-label">Origen del dinero</label>
                    <select class="form-select" id="invOrigen">
                        <option value="bbva">BBVA (${fmt(state.patrimonio.bbva, 'USD')})</option>
                        <option value="caja">Caja Seguridad (${fmt(state.patrimonio.caja, 'USD')})</option>
                        <option value="efectivo">Efectivo (${fmt(state.patrimonio.efectivo, 'USD')})</option>
                        <option value="externo">Externo (no descontar)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Monto USD</label>
                    <div class="amount-wrap">
                        <span class="amount-prefix">$</span>
                        <input type="number" class="form-input amount-input" id="invMonto" step="0.01">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tasa Anual %</label>
                        <input type="number" class="form-input" id="invTasa" placeholder="7" step="0.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pago Intereses</label>
                        <select class="form-select" id="invFrecuencia">
                            <option value="Trimestral">Trimestral</option>
                            <option value="Semestral">Semestral</option>
                            <option value="Anual">Anual</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Fecha Compra</label>
                        <input type="date" class="form-input" id="invFechaCompra" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Vencimiento</label>
                        <input type="date" class="form-input" id="invVencimiento">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveNewInversion()">Guardar</button>
            </div>
        `);
    };

    window.saveNewInversion = function() {
        const origen = document.getElementById('invOrigen').value;
        const monto = parseFloat(document.getElementById('invMonto').value);
        const nombre = document.getElementById('invNombre').value;
        
        if (!nombre || !monto) {
            toast('Complet√° nombre y monto', true);
            return;
        }

        // Verificar saldo si no es externo
        if (origen !== 'externo' && state.patrimonio[origen] < monto) {
            toast('Saldo insuficiente en ' + origen.toUpperCase(), true);
            return;
        }

        const inversion = {
            id: Date.now(),
            nombre: nombre,
            monto: monto,
            tasa: parseFloat(document.getElementById('invTasa').value) || 0,
            frecuencia: document.getElementById('invFrecuencia').value,
            fechaCompra: document.getElementById('invFechaCompra').value,
            vencimiento: document.getElementById('invVencimiento').value,
            origen: origen !== 'externo' ? origen.toUpperCase() : 'Externo'
        };

        // Descontar del origen si corresponde
        if (origen !== 'externo') {
            state.patrimonio[origen] -= monto;
            
            // Registrar movimiento
            state.movimientos.unshift({
                id: Date.now(),
                fecha: inversion.fechaCompra,
                origen: origen.toUpperCase(),
                destino: inversion.nombre,
                monto: monto,
                nota: 'Compra inversi√≥n'
            });
        }

        state.inversiones.push(inversion);
        saveState();
        hideModal();
        renderCurrentView();
        toast('Inversi√≥n agregada');
    };

    // Modal: Edit Inversi√≥n
    window.showEditInversionModal = function(id) {
        const inv = state.inversiones.find(i => i.id === id);
        if (!inv) return;

        showModal(`
            <div class="modal-header">
                <span class="modal-title">Editar Inversi√≥n</span>
                <button class="modal-close" onclick="hideModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nombre</label>
                    <input type="text" class="form-input" id="editInvNombre" value="${inv.nombre}">
                </div>
                <div class="form-group">
                    <label class="form-label">Monto USD</label>
                    <div class="amount-wrap">
                        <span class="amount-prefix">$</span>
                        <input type="number" class="form-input amount-input" id="editInvMonto" value="${inv.monto}" step="0.01">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tasa Anual %</label>
                        <input type="number" class="form-input" id="editInvTasa" value="${inv.tasa}" step="0.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pago Intereses</label>
                        <select class="form-select" id="editInvFrecuencia">
                            <option value="Trimestral" ${inv.frecuencia === 'Trimestral' ? 'selected' : ''}>Trimestral</option>
                            <option value="Semestral" ${inv.frecuencia === 'Semestral' ? 'selected' : ''}>Semestral</option>
                            <option value="Anual" ${inv.frecuencia === 'Anual' ? 'selected' : ''}>Anual</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Fecha Compra</label>
                        <input type="date" class="form-input" id="editInvFechaCompra" value="${inv.fechaCompra}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Vencimiento</label>
                        <input type="date" class="form-input" id="editInvVencimiento" value="${inv.vencimiento}">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveInversionEdit(${id})">Guardar</button>
            </div>
        `);
    };

    window.saveInversionEdit = function(id) {
        const inv = state.inversiones.find(i => i.id === id);
        if (inv) {
            inv.nombre = document.getElementById('editInvNombre').value;
            inv.monto = parseFloat(document.getElementById('editInvMonto').value);
            inv.tasa = parseFloat(document.getElementById('editInvTasa').value);
            inv.frecuencia = document.getElementById('editInvFrecuencia').value;
            inv.fechaCompra = document.getElementById('editInvFechaCompra').value;
            inv.vencimiento = document.getElementById('editInvVencimiento').value;
            saveState();
            hideModal();
            renderCurrentView();
            toast('Inversi√≥n actualizada');
        }
    };

    window.deleteInversion = function(id) {
        if (confirm('¬øEliminar esta inversi√≥n?')) {
            state.inversiones = state.inversiones.filter(i => i.id !== id);
            saveState();
            renderCurrentView();
            toast('Inversi√≥n eliminada');
        }
    };

    // ============================================================
    // INICIALIZACI√ìN
    // ============================================================
    document.addEventListener('DOMContentLoaded', () => {
        loadState();
        renderCurrentView();
        fetchCotizaciones();

        // Actualizar cotizaciones cada 5 minutos
        setInterval(fetchCotizaciones, 5 * 60 * 1000);

        // Navegaci√≥n
        document.querySelectorAll('.nav-btn, .bnav-item').forEach(btn => {
            btn.addEventListener('click', () => switchView(btn.dataset.view));
        });

        // Intentar sincronizar
        syncWithSheets();
    });

    // Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }
    </script>
</body>
</html>
